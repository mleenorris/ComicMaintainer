<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Maintainer - Web Interface</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --bg-tertiary: #ecf0f1;
            --bg-header: #2c3e50;
            --bg-hover: #f8f9fa;
            --bg-hover-alt: #e9ecef;
            --bg-indented: #fafafa;
            --bg-indented-hover: #f0f0f0;
            
            --text-primary: #333;
            --text-secondary: #2c3e50;
            --text-muted: #7f8c8d;
            --text-light: #95a5a6;
            --text-header: white;
            
            --border-primary: #ecf0f1;
            --border-secondary: #bdc3c7;
            --border-tertiary: #e0e0e0;
            --border-input: #ddd;
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.3);
            
            --modal-overlay: rgba(0,0,0,0.5);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --bg-header: #1f2937;
            --bg-hover: #3a3a3a;
            --bg-hover-alt: #404040;
            --bg-indented: #252525;
            --bg-indented-hover: #303030;
            
            --text-primary: #e5e5e5;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --text-light: #6b7280;
            --text-header: white;
            
            --border-primary: #404040;
            --border-secondary: #4a4a4a;
            --border-tertiary: #3a3a3a;
            --border-input: #4a4a4a;
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.5);
            
            --modal-overlay: rgba(0,0,0,0.7);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .header {
            background: var(--bg-header);
            color: var(--text-header);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .header h1 {
            margin-bottom: 10px;
        }
        
        .header-actions {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-header);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .actions-bar {
            background: var(--bg-secondary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-bar {
            background: var(--bg-secondary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-input);
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }
        
        .search-bar input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-rename {
            background: #9b59b6;
            color: white;
        }
        
        .btn-rename:hover {
            background: #8e44ad;
        }
        
        .btn-normalize {
            background: #16a085;
            color: white;
        }
        
        .btn-normalize:hover {
            background: #138d75;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .file-list {
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .file-list-header {
            background: var(--bg-tertiary);
            padding: 15px;
            font-weight: 600;
            display: grid;
            grid-template-columns: 40px 1fr 150px 240px;
            gap: 10px;
            border-bottom: 2px solid var(--border-secondary);
        }
        
        .directory-header {
            padding: 12px 15px;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            transition: background 0.2s;
        }
        
        .directory-header-clickable {
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .directory-header:hover {
            background: var(--bg-hover-alt);
        }
        
        .directory-toggle {
            font-size: 12px;
            transition: transform 0.2s;
            display: inline-block;
            width: 16px;
            flex-shrink: 0;
        }
        
        .directory-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .directory-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .directory-path {
            font-size: 14px;
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 150px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .directory-file-count {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: normal;
            flex-shrink: 0;
        }
        
        .directory-content {
            display: block;
        }
        
        .directory-content.collapsed {
            display: none;
        }
        
        .file-item {
            padding: 15px;
            display: grid;
            grid-template-columns: 40px 1fr 150px 240px;
            gap: 10px;
            border-bottom: 1px solid var(--border-primary);
            align-items: center;
            transition: background 0.2s;
        }
        
        .file-item.indented {
            padding-left: 35px;
            background: var(--bg-indented);
        }
        
        .file-item:hover {
            background: var(--bg-hover);
        }
        
        .file-item.indented:hover {
            background: var(--bg-indented-hover);
        }
        
        .file-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .file-path {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 3px;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 5px 12px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 8px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .close-btn:hover {
            color: var(--text-muted);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-input);
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-group code {
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .select-info {
            margin-left: auto;
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .page-info {
            color: var(--text-muted);
            font-size: 14px;
            min-width: 100px;
            text-align: center;
        }
        
        /* Intermediate Desktop Responsive Styles (Tablets & Small Desktops) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .btn {
                padding: 9px 16px;
                font-size: 13px;
            }
            
            .select-info {
                flex-basis: 100%;
                text-align: center;
                margin-left: 0;
                margin-top: 8px;
            }
            
            .file-list-header {
                grid-template-columns: 40px 1fr 120px 200px;
            }
            
            .file-item {
                grid-template-columns: 40px 1fr 120px 200px;
            }
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .actions-bar {
                padding: 10px;
                gap: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 13px;
                flex: 1 1 auto;
                min-width: 0;
            }
            
            .select-info {
                flex-basis: 100%;
                text-align: center;
                margin-left: 0;
                margin-top: 5px;
            }
            
            .file-list-header {
                grid-template-columns: 30px 1fr 80px;
                padding: 10px;
                font-size: 13px;
            }
            
            .file-list-header > div:nth-child(4) {
                display: none;
            }
            
            .file-item {
                grid-template-columns: 30px 1fr 80px;
                padding: 10px;
                gap: 8px;
            }
            
            .file-item.indented {
                padding-left: 25px;
            }
            
            .file-item > div:nth-child(4) {
                grid-column: 2 / 4;
                margin-top: 8px;
            }
            
            .file-actions {
                flex-direction: column;
                gap: 5px;
                width: 100%;
            }
            
            .btn-small {
                width: 100%;
                text-align: center;
            }
            
            .file-name {
                font-size: 14px;
            }
            
            .file-path {
                font-size: 11px;
            }
            
            .directory-header {
                padding: 10px;
                font-size: 13px;
            }
            
            .directory-path {
                font-size: 13px;
                max-width: calc(100% - 100px);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 1;
            }
            
            .directory-file-count {
                flex-shrink: 0;
            }
            
            .modal-content {
                max-width: 95%;
                margin: 10px;
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 15px;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            .form-group input,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .pagination {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .pagination > div {
                margin-left: 0 !important;
                flex-basis: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .btn {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .file-list-header,
            .file-item {
                grid-template-columns: 25px 1fr 70px;
            }
            
            .directory-header {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Comic Maintainer <span id="appVersion" style="font-size: 0.5em; color: rgba(255, 255, 255, 0.7);"></span></h1>
            <p>Manage and process comic files in your watched directory</p>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">🌙</span>
                    <span id="themeText">Dark Mode</span>
                </button>
                <button class="theme-toggle" onclick="toggleWatcher()" id="watcherToggle">
                    <span id="watcherIcon">👁️</span>
                    <span id="watcherText">Watcher: Loading...</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div id="messageContainer"></div>
        
        <div class="actions-bar">
            <button class="btn btn-success" onclick="processAllFiles()">
                🚀 Process All (Rename + Normalize)
            </button>
            <button class="btn btn-success" onclick="processUnmarkedFiles()">
                ⚠️ Process Unmarked (Rename + Normalize)
            </button>
            <button class="btn btn-success" onclick="processSelectedFiles()" id="processSelectedBtn" disabled>
                ⚡ Process Selected (Rename + Normalize)
            </button>
            <button class="btn btn-rename" onclick="renameAllFiles()">
                📝 Rename All Files
            </button>
            <button class="btn btn-rename" onclick="renameUnmarkedFiles()">
                📝 Rename Unmarked
            </button>
            <button class="btn btn-rename" onclick="renameSelectedFiles()" id="renameSelectedBtn" disabled>
                📝 Rename Selected
            </button>
            <button class="btn btn-normalize" onclick="normalizeAllFiles()">
                🔧 Normalize All Metadata
            </button>
            <button class="btn btn-normalize" onclick="normalizeUnmarkedFiles()">
                🔧 Normalize Unmarked Metadata
            </button>
            <button class="btn btn-normalize" onclick="normalizeSelectedFiles()" id="normalizeSelectedBtn" disabled>
                🔧 Normalize Selected Metadata
            </button>
        </div>
        
        <div class="actions-bar" style="margin-top: -10px;">
            <button class="btn btn-warning" onclick="batchUpdateTags()" id="batchUpdateBtn" disabled>
                ✏️ Update Selected
            </button>
            <button class="btn btn-primary" onclick="refreshFiles()">
                🔄 Refresh
            </button>
            <button class="btn btn-primary" onclick="scanUnmarkedFiles()">
                🔍 Scan Unmarked
            </button>
            <button class="btn btn-primary" onclick="toggleAllFolders()" id="toggleAllBtn">
                📂 Collapse All
            </button>
            <button class="btn" onclick="openSettings()" style="background: #95a5a6; color: white;">
                ⚙️ Settings
            </button>
            <span class="select-info" id="selectInfo">No files selected</span>
        </div>
        
        <div class="actions-bar" style="margin-top: -10px;">
            <button class="btn" onclick="setFilter('all')" id="filterAll" style="background: #3498db; color: white;">
                📚 All Files
            </button>
            <button class="btn" onclick="setFilter('unmarked')" id="filterUnmarked">
                ⚠️ Unmarked Only
            </button>
            <button class="btn" onclick="setFilter('marked')" id="filterMarked">
                ✅ Marked Only
            </button>
            <button class="btn" onclick="setFilter('duplicates')" id="filterDuplicates">
                🔁 Duplicates Only
            </button>
        </div>
        
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="🔍 Search files..." oninput="debouncedFilterFiles()" />
        </div>
        
        <div class="file-list" id="fileList">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading files...</p>
            </div>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="btn btn-small" id="prevBtn" onclick="previousPage()" disabled>← Previous</button>
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <button class="btn btn-small" id="nextBtn" onclick="nextPage()" disabled>Next →</button>
            <div style="display: flex; align-items: center; gap: 8px; margin-left: 15px;">
                <label for="perPageSelect" style="color: var(--text-secondary); font-size: 14px;">Files per page:</label>
                <select id="perPageSelect" onchange="changePerPage()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border-primary); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="-1">All</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Tag Editor Modal -->
    <div class="modal" id="tagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Tags</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tagForm">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" name="title">
                    </div>
                    <div class="form-group">
                        <label for="series">Series</label>
                        <input type="text" id="series" name="series">
                    </div>
                    <div class="form-group">
                        <label for="issue">Issue</label>
                        <input type="text" id="issue" name="issue">
                    </div>
                    <div class="form-group">
                        <label for="volume">Volume</label>
                        <input type="text" id="volume" name="volume">
                    </div>
                    <div class="form-group">
                        <label for="publisher">Publisher</label>
                        <input type="text" id="publisher" name="publisher">
                    </div>
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="text" id="year" name="year">
                    </div>
                    <div class="form-group">
                        <label for="month">Month</label>
                        <input type="text" id="month" name="month">
                    </div>
                    <div class="form-group">
                        <label for="writer">Writer</label>
                        <input type="text" id="writer" name="writer">
                    </div>
                    <div class="form-group">
                        <label for="summary">Summary</label>
                        <textarea id="summary" name="summary"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTags()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Batch Update Modal -->
    <div class="modal" id="batchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Batch Update Tags</h2>
                <button class="close-btn" onclick="closeBatchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #7f8c8d;">
                    Only fill in the fields you want to update for all selected files.
                    Empty fields will be ignored.
                </p>
                <form id="batchForm">
                    <div class="form-group">
                        <label for="batch_series">Series</label>
                        <input type="text" id="batch_series" name="series">
                    </div>
                    <div class="form-group">
                        <label for="batch_publisher">Publisher</label>
                        <input type="text" id="batch_publisher" name="publisher">
                    </div>
                    <div class="form-group">
                        <label for="batch_year">Year</label>
                        <input type="text" id="batch_year" name="year">
                    </div>
                    <div class="form-group">
                        <label for="batch_writer">Writer</label>
                        <input type="text" id="batch_writer" name="writer">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeBatchModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveBatchTags()">Update Selected Files</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom: 10px; color: var(--text-secondary);">Filename Format</h3>
                <p style="margin-bottom: 15px; color: var(--text-muted); font-size: 14px;">
                    Configure how files are renamed when processed. Use placeholders like <code>{series}</code>, <code>{issue}</code>, etc.
                </p>
                <div class="form-group">
                    <label for="filenameFormat">Filename Template</label>
                    <input type="text" id="filenameFormat" placeholder="{series} - Chapter {issue}.cbz">
                    <small style="display: block; margin-top: 5px; color: var(--text-muted);">
                        Available placeholders:
                    </small>
                    <ul style="margin: 10px 0 10px 20px; color: var(--text-muted); font-size: 13px; line-height: 1.6;">
                        <li><code>{series}</code> - Series name</li>
                        <li><code>{issue}</code> - Issue number (padded to 4 digits, e.g., 0001, or 0071.4 for decimals)</li>
                        <li><code>{issue_no_pad}</code> - Issue number (no padding, e.g., 1, or 71.4 for decimals)</li>
                        <li><code>{title}</code> - Issue title</li>
                        <li><code>{volume}</code> - Volume number</li>
                        <li><code>{year}</code> - Publication year</li>
                        <li><code>{publisher}</code> - Publisher name</li>
                    </ul>
                    <small style="display: block; margin-top: 10px; color: var(--text-muted);">
                        <strong>Example:</strong> <code>{series} v{volume} #{issue_no_pad} ({year}).cbz</code>
                    </small>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: var(--bg-hover); border-radius: 5px;">
                    <small style="color: var(--text-muted);">
                        <strong>Current format:</strong> <span id="currentFormat" style="font-family: monospace;"></span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeSettings()">Cancel</button>
                <button class="btn" onclick="resetFilenameFormat()" style="background: #e67e22; color: white;">Reset to Default</button>
                <button class="btn btn-primary" onclick="saveFilenameFormat()">Save</button>
            </div>
        </div>
    </div>
    
    <script>
        let files = [];
        let selectedFiles = new Set();
        let currentEditFile = null;
        let collapsedDirectories = new Set();
        let searchQuery = '';
        let allFoldersExpanded = true;
        let currentPage = 1;
        let totalPages = 1;
        let totalFiles = 0;
        let unmarkedCount = 0;
        let perPage = parseInt(localStorage.getItem('perPage')) || 100;
        let filterMode = 'all'; // 'all', 'marked', 'unmarked', 'duplicates'
        let searchDebounceTimer = null;
        
        // Debounce function for search input
        function debouncedFilterFiles() {
            // Clear existing timer
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            // Set new timer to trigger after 300ms of inactivity
            searchDebounceTimer = setTimeout(() => {
                filterFiles();
            }, 300);
        }
        
        // Theme management
        function initTheme() {
            // Check if user has a saved preference
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme) {
                // Use saved preference
                setTheme(savedTheme);
            } else {
                // Use system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
            }
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // Only auto-switch if user hasn't set a preference
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeButton(theme);
        }
        
        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '🌙';
                text.textContent = 'Dark Mode';
            }
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // Load watcher status
        async function loadWatcherStatus() {
            try {
                const response = await fetch('/api/settings/watcher-enabled');
                const data = await response.json();
                updateWatcherButton(data.enabled);
            } catch (error) {
                console.error('Error loading watcher status:', error);
                updateWatcherButton(true); // Default to enabled on error
            }
        }
        
        // Update watcher button display
        function updateWatcherButton(enabled) {
            const iconElement = document.getElementById('watcherIcon');
            const textElement = document.getElementById('watcherText');
            const buttonElement = document.getElementById('watcherToggle');
            
            if (enabled) {
                iconElement.textContent = '👁️';
                textElement.textContent = 'Watcher: ON';
                buttonElement.style.background = 'rgba(46, 204, 113, 0.2)';
                buttonElement.style.borderColor = 'rgba(46, 204, 113, 0.4)';
            } else {
                iconElement.textContent = '👁️‍🗨️';
                textElement.textContent = 'Watcher: OFF';
                buttonElement.style.background = 'rgba(231, 76, 60, 0.2)';
                buttonElement.style.borderColor = 'rgba(231, 76, 60, 0.4)';
            }
        }
        
        // Toggle watcher on/off
        async function toggleWatcher() {
            try {
                // Get current status first
                const statusResponse = await fetch('/api/settings/watcher-enabled');
                const statusData = await statusResponse.json();
                const currentStatus = statusData.enabled;
                
                // Toggle it
                const newStatus = !currentStatus;
                const response = await fetch('/api/settings/watcher-enabled', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateWatcherButton(result.enabled);
                    const statusText = result.enabled ? 'enabled' : 'disabled';
                    showMessage(`Watcher ${statusText} successfully!`, 'success');
                } else {
                    showMessage(result.error || 'Failed to toggle watcher', 'error');
                }
            } catch (error) {
                showMessage('Failed to toggle watcher: ' + error.message, 'error');f
            }
        }
        
        // Fetch and display version
        async function loadVersion() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                const versionElement = document.getElementById('appVersion');
                if (versionElement && data.version) {
                    versionElement.textContent = `v${data.version}`;
                }
            } catch (error) {
                console.error('Error loading version:', error);
            }
        }
        
        // Load files on page load
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            loadVersion();
            loadWatcherStatus();
            
            // Set the per-page selector to the saved value
            const perPageSelect = document.getElementById('perPageSelect');
            if (perPageSelect) {
                perPageSelect.value = perPage;
            }
            
            loadFiles();
        });
        
        async function loadFiles(page = 1, refresh = false) {
            try {
                let url = `/api/files?page=${page}&per_page=${perPage}`;
                if (refresh) {
                    url += '&refresh=true';
                }
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterMode !== 'all') {
                    url += `&filter=${encodeURIComponent(filterMode)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                files = data.files;
                currentPage = data.page;
                totalPages = data.total_pages;
                totalFiles = data.total_files;
                unmarkedCount = data.unmarked_count || 0;
                
                renderFileList();
                updatePagination();
                updateButtonVisibility();
            } catch (error) {
                showMessage('Failed to load files: ' + error.message, 'error');
            }
        }
        
        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (totalPages > 1 || totalFiles > 0) {
                paginationDiv.style.display = 'flex';
                let pageText = `Page ${currentPage} of ${totalPages} (${totalFiles} file${totalFiles !== 1 ? 's' : ''}`;
                if (searchQuery || filterMode !== 'all') {
                    pageText += ' matching';
                }
                pageText += ')';
                pageInfo.textContent = pageText;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                paginationDiv.style.display = 'none';
            }
        }
        
        function updateButtonVisibility() {
            // Get all unmarked-related buttons
            const processUnmarkedBtn = document.querySelector('button[onclick="processUnmarkedFiles()"]');
            const renameUnmarkedBtn = document.querySelector('button[onclick="renameUnmarkedFiles()"]');
            const normalizeUnmarkedBtn = document.querySelector('button[onclick="normalizeUnmarkedFiles()"]');
            const filterUnmarkedBtn = document.getElementById('filterUnmarked');
            
            // Show or hide buttons based on whether there are unmarked files
            const hasUnmarkedFiles = unmarkedCount > 0;
            const displayStyle = hasUnmarkedFiles ? '' : 'none';
            
            if (processUnmarkedBtn) processUnmarkedBtn.style.display = displayStyle;
            if (renameUnmarkedBtn) renameUnmarkedBtn.style.display = displayStyle;
            if (normalizeUnmarkedBtn) normalizeUnmarkedBtn.style.display = displayStyle;
            if (filterUnmarkedBtn) filterUnmarkedBtn.style.display = displayStyle;
        }
        
        function changePerPage() {
            const perPageSelect = document.getElementById('perPageSelect');
            perPage = parseInt(perPageSelect.value);
            
            // Save to localStorage
            localStorage.setItem('perPage', perPage);
            
            // Reload files from page 1 with new per-page value
            loadFiles(1);
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                loadFiles(currentPage + 1);
            }
        }
        
        function previousPage() {
            if (currentPage > 1) {
                loadFiles(currentPage - 1);
            }
        }
        
        function filterFiles() {
            searchQuery = document.getElementById('searchInput').value;
            // Reload from page 1 with new search query
            loadFiles(1);
        }
        
        function setFilter(mode) {
            filterMode = mode;
            
            // Update button styles
            document.getElementById('filterAll').style.background = mode === 'all' ? '#3498db' : '';
            document.getElementById('filterAll').style.color = mode === 'all' ? 'white' : '';
            document.getElementById('filterUnmarked').style.background = mode === 'unmarked' ? '#e67e22' : '';
            document.getElementById('filterUnmarked').style.color = mode === 'unmarked' ? 'white' : '';
            document.getElementById('filterMarked').style.background = mode === 'marked' ? '#27ae60' : '';
            document.getElementById('filterMarked').style.color = mode === 'marked' ? 'white' : '';
            document.getElementById('filterDuplicates').style.background = mode === 'duplicates' ? '#e74c3c' : '';
            document.getElementById('filterDuplicates').style.color = mode === 'duplicates' ? 'white' : '';
            
            // Reload from page 1 with new filter
            loadFiles(1);
        }
        
        async function scanUnmarkedFiles() {
            try {
                showMessage('Scanning for unmarked files...', 'info');
                const response = await fetch('/api/scan-unmarked');
                const data = await response.json();
                
                showMessage(`Found ${data.unmarked_count} unmarked file(s) and ${data.marked_count} marked file(s) out of ${data.total_count} total files.`, 'success');
            } catch (error) {
                showMessage('Failed to scan files: ' + error.message, 'error');
            }
        }
        
        function renderFileList() {
            const fileList = document.getElementById('fileList');
            
            if (files.length === 0) {
                // Check if we have search/filter active to show appropriate message
                if (searchQuery || filterMode !== 'all') {
                    fileList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <h2>No matching files found</h2>
                            <p>Try a different search term or filter</p>
                        </div>
                    `;
                } else {
                    fileList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📁</div>
                            <h2>No comic files found</h2>
                            <p>Add some .cbz or .cbr files to your watched directory</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Group files by directory (filtering is now done on backend)
            const filesByDirectory = {};
            files.forEach(file => {
                const dirPath = file.relative_path.includes('/') || file.relative_path.includes('\\') 
                    ? file.relative_path.substring(0, file.relative_path.lastIndexOf(file.relative_path.includes('/') ? '/' : '\\'))
                    : '';
                if (!filesByDirectory[dirPath]) {
                    filesByDirectory[dirPath] = [];
                }
                filesByDirectory[dirPath].push(file);
            });
            
            // Sort directories
            const sortedDirs = Object.keys(filesByDirectory).sort();
            
            let html = `
                <div class="file-list-header">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                    <div>File</div>
                    <div>Size</div>
                    <div>Actions</div>
                </div>
            `;
            
            // Render files grouped by directory
            sortedDirs.forEach(dir => {
                const isCollapsed = collapsedDirectories.has(dir);
                const fileCount = filesByDirectory[dir].length;
                
                if (dir) {
                    const allSelected = filesByDirectory[dir].every(file => selectedFiles.has(file.relative_path));
                    const someSelected = filesByDirectory[dir].some(file => selectedFiles.has(file.relative_path));
                    html += `
                        <div class="directory-header">
                            <input type="checkbox" 
                                   ${allSelected ? 'checked' : ''} 
                                   ${someSelected && !allSelected ? 'style="opacity: 0.5"' : ''}
                                   onchange="toggleDirectorySelection('${escapeJs(dir)}', this.checked)"
                                   onclick="event.stopPropagation()">
                            <div class="directory-header-clickable" onclick="toggleDirectory('${escapeJs(dir)}')">
                                <span class="directory-toggle ${isCollapsed ? 'collapsed' : ''}">▼</span>
                                <span class="directory-icon">📁</span>
                                <span class="directory-path">${escapeHtml(dir)}</span>
                                <span class="directory-file-count">(${fileCount} file${fileCount !== 1 ? 's' : ''})</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `<div class="directory-content ${isCollapsed ? 'collapsed' : ''}" data-dir="${escapeHtml(dir)}">`;
                
                filesByDirectory[dir].forEach(file => {
                    const isSelected = selectedFiles.has(file.relative_path);
                    const fileSize = formatFileSize(file.size);
                    const processedBadge = file.processed ? '✅' : '⚠️';
                    const processedTitle = file.processed ? 'Processed' : 'Not processed yet';
                    const duplicateBadge = file.duplicate ? '🔁' : '';
                    const duplicateTitle = file.duplicate ? 'Duplicate' : '';
                    html += `
                        <div class="file-item ${dir ? 'indented' : ''}">
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleFileSelection('${escapeJs(file.relative_path)}', this.checked)">
                            <div>
                                <div class="file-name">
                                    <span title="${processedTitle}">${processedBadge}</span>${duplicateBadge ? ` <span title="${duplicateTitle}">${duplicateBadge}</span>` : ''} ${escapeHtml(file.name)}
                                </div>
                                ${!dir ? `<div class="file-path">${escapeHtml(file.relative_path)}</div>` : ''}
                            </div>
                            <div>${fileSize}</div>
                            <div class="file-actions">
                                <button class="btn btn-primary btn-small" onclick="viewTags('${escapeJs(file.relative_path)}')">
                                    View/Edit
                                </button>
                                <button class="btn btn-success btn-small" onclick="processSingleFile('${escapeJs(file.relative_path)}')">
                                    Process
                                </button>
                                <button class="btn btn-rename btn-small" onclick="renameSingleFile('${escapeJs(file.relative_path)}')">
                                    Rename
                                </button>
                                <button class="btn btn-normalize btn-small" onclick="normalizeSingleFile('${escapeJs(file.relative_path)}')">
                                    Normalize
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteSingleFile('${escapeJs(file.relative_path)}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            fileList.innerHTML = html;
            updateSelectInfo();
            updateToggleAllButton();
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeJs(text) {
            // Escape single quotes, double quotes, backslashes, and other special characters for JavaScript strings
            return text.replace(/\\/g, '\\\\')
                       .replace(/'/g, "\\'")
                       .replace(/"/g, '\\"')
                       .replace(/\n/g, '\\n')
                       .replace(/\r/g, '\\r')
                       .replace(/\t/g, '\\t');
        }
        
        function toggleSelectAll(checked) {
            selectedFiles.clear();
            if (checked) {
                files.forEach(file => selectedFiles.add(file.relative_path));
            }
            renderFileList();
        }
        
        function toggleFileSelection(filepath, checked) {
            if (checked) {
                selectedFiles.add(filepath);
            } else {
                selectedFiles.delete(filepath);
            }
            updateSelectInfo();
        }
        
        function updateSelectInfo() {
            const count = selectedFiles.size;
            const info = document.getElementById('selectInfo');
            const batchBtn = document.getElementById('batchUpdateBtn');
            const processSelectedBtn = document.getElementById('processSelectedBtn');
            const renameSelectedBtn = document.getElementById('renameSelectedBtn');
            const normalizeSelectedBtn = document.getElementById('normalizeSelectedBtn');
            
            if (count === 0) {
                info.textContent = 'No files selected';
                batchBtn.disabled = true;
                processSelectedBtn.disabled = true;
                renameSelectedBtn.disabled = true;
                normalizeSelectedBtn.disabled = true;
            } else {
                info.textContent = `${count} file${count > 1 ? 's' : ''} selected`;
                batchBtn.disabled = false;
                processSelectedBtn.disabled = false;
                renameSelectedBtn.disabled = false;
                normalizeSelectedBtn.disabled = false;
            }
        }
        
        function toggleDirectory(dir) {
            if (collapsedDirectories.has(dir)) {
                collapsedDirectories.delete(dir);
            } else {
                collapsedDirectories.add(dir);
            }
            updateToggleAllButton();
            renderFileList();
        }
        
        function toggleAllFolders() {
            if (allFoldersExpanded) {
                collapseAllFolders();
            } else {
                expandAllFolders();
            }
        }
        
        function expandAllFolders() {
            collapsedDirectories.clear();
            allFoldersExpanded = true;
            updateToggleAllButton();
            renderFileList();
        }
        
        function collapseAllFolders() {
            // Get all directories from files
            const allDirs = new Set();
            files.forEach(file => {
                const dirPath = file.relative_path.includes('/') || file.relative_path.includes('\\') 
                    ? file.relative_path.substring(0, file.relative_path.lastIndexOf(file.relative_path.includes('/') ? '/' : '\\'))
                    : '';
                if (dirPath) {
                    allDirs.add(dirPath);
                }
            });
            
            // Collapse all directories
            collapsedDirectories = new Set(allDirs);
            allFoldersExpanded = false;
            updateToggleAllButton();
            renderFileList();
        }
        
        function updateToggleAllButton() {
            const btn = document.getElementById('toggleAllBtn');
            if (!btn) return;
            
            // Count total directories
            const allDirs = new Set();
            files.forEach(file => {
                const dirPath = file.relative_path.includes('/') || file.relative_path.includes('\\') 
                    ? file.relative_path.substring(0, file.relative_path.lastIndexOf(file.relative_path.includes('/') ? '/' : '\\'))
                    : '';
                if (dirPath) {
                    allDirs.add(dirPath);
                }
            });
            
            // Update button based on state
            if (collapsedDirectories.size === allDirs.size && allDirs.size > 0) {
                btn.textContent = '📂 Expand All';
                allFoldersExpanded = false;
            } else {
                btn.textContent = '📂 Collapse All';
                allFoldersExpanded = true;
            }
        }
        
        function toggleDirectorySelection(dir, checked) {
            // Find all files in this directory
            const dirFiles = files.filter(file => {
                const fileDirPath = file.relative_path.includes('/') || file.relative_path.includes('\\') 
                    ? file.relative_path.substring(0, file.relative_path.lastIndexOf(file.relative_path.includes('/') ? '/' : '\\'))
                    : '';
                return fileDirPath === dir;
            });
            
            // Update selection
            dirFiles.forEach(file => {
                if (checked) {
                    selectedFiles.add(file.relative_path);
                } else {
                    selectedFiles.delete(file.relative_path);
                }
            });
            
            renderFileList();
        }
        
        async function viewTags(filepath) {
            try {
                const response = await fetch(`/api/file/${encodeURIComponent(filepath)}/tags`);
                const tags = await response.json();
                
                if (tags.error) {
                    showMessage(tags.error, 'error');
                    return;
                }
                
                currentEditFile = filepath;
                
                // Populate form
                Object.keys(tags).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = tags[key] || '';
                    }
                });
                
                document.getElementById('modalTitle').textContent = `Edit Tags - ${filepath}`;
                document.getElementById('tagModal').classList.add('active');
            } catch (error) {
                showMessage('Failed to load tags: ' + error.message, 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('tagModal').classList.remove('active');
            currentEditFile = null;
        }
        
        async function saveTags() {
            if (!currentEditFile) return;
            
            const form = document.getElementById('tagForm');
            const formData = new FormData(form);
            const tags = {};
            
            for (let [key, value] of formData.entries()) {
                tags[key] = value;
            }
            
            try {
                const response = await fetch(`/api/file/${encodeURIComponent(currentEditFile)}/tags`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tags)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Tags updated successfully!', 'success');
                    closeModal();
                } else {
                    showMessage(result.error || 'Failed to update tags', 'error');
                }
            } catch (error) {
                showMessage('Failed to save tags: ' + error.message, 'error');
            }
        }
        
        function batchUpdateTags() {
            if (selectedFiles.size === 0) return;
            document.getElementById('batchModal').classList.add('active');
        }
        
        function closeBatchModal() {
            document.getElementById('batchModal').classList.remove('active');
            document.getElementById('batchForm').reset();
        }
        
        async function saveBatchTags() {
            const form = document.getElementById('batchForm');
            const formData = new FormData(form);
            const tags = {};
            
            // Only include non-empty fields
            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    tags[key] = value;
                }
            }
            
            if (Object.keys(tags).length === 0) {
                showMessage('Please enter at least one tag to update', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/files/tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: Array.from(selectedFiles),
                        tags: tags
                    })
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Updated ${successCount} of ${result.results.length} files successfully!`, 'success');
                closeBatchModal();
            } catch (error) {
                showMessage('Failed to batch update: ' + error.message, 'error');
            }
        }
        
        async function processAllFiles() {
            if (!confirm('This will process all files in the watched directory. Continue?')) {
                return;
            }
            
            showMessage('Processing all files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/process-all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Processed ${successCount} of ${result.results.length} files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to process files: ' + error.message, 'error');
            }
        }
        
        async function renameAllFiles() {
            if (!confirm('This will rename all files in the watched directory based on metadata. Continue?')) {
                return;
            }
            
            showMessage('Renaming all files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/rename-all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Renamed ${successCount} of ${result.results.length} files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to rename files: ' + error.message, 'error');
            }
        }
        
        async function normalizeAllFiles() {
            if (!confirm('This will normalize metadata for all files in the watched directory. Continue?')) {
                return;
            }
            
            showMessage('Normalizing metadata for all files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/normalize-all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Normalized metadata for ${successCount} of ${result.results.length} files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to normalize metadata: ' + error.message, 'error');
            }
        }
        
        async function processUnmarkedFiles() {
            if (!confirm('This will process all unmarked files in the watched directory. Continue?')) {
                return;
            }
            
            showMessage('Processing unmarked files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/process-unmarked', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Processed ${successCount} of ${result.results.length} unmarked files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to process unmarked files: ' + error.message, 'error');
            }
        }
        
        async function renameUnmarkedFiles() {
            if (!confirm('This will rename all unmarked files in the watched directory based on metadata. Continue?')) {
                return;
            }
            
            showMessage('Renaming unmarked files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/rename-unmarked', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Renamed ${successCount} of ${result.results.length} unmarked files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to rename unmarked files: ' + error.message, 'error');
            }
        }
        
        async function normalizeUnmarkedFiles() {
            if (!confirm('This will normalize metadata for all unmarked files in the watched directory. Continue?')) {
                return;
            }
            
            showMessage('Normalizing metadata for unmarked files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/normalize-unmarked', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Normalized metadata for ${successCount} of ${result.results.length} unmarked files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to normalize metadata for unmarked files: ' + error.message, 'error');
            }
        }
        
        async function processSelectedFiles() {
            if (selectedFiles.size === 0) {
                showMessage('No files selected', 'error');
                return;
            }
            
            if (!confirm(`This will process ${selectedFiles.size} selected file${selectedFiles.size > 1 ? 's' : ''}. Continue?`)) {
                return;
            }
            
            showMessage('Processing selected files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/process-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: Array.from(selectedFiles)
                    })
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Processed ${successCount} of ${result.results.length} files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to process files: ' + error.message, 'error');
            }
        }
        
        async function renameSelectedFiles() {
            if (selectedFiles.size === 0) {
                showMessage('No files selected', 'error');
                return;
            }
            
            if (!confirm(`This will rename ${selectedFiles.size} selected file${selectedFiles.size > 1 ? 's' : ''} based on metadata. Continue?`)) {
                return;
            }
            
            showMessage('Renaming selected files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/rename-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: Array.from(selectedFiles)
                    })
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Renamed ${successCount} of ${result.results.length} files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to rename files: ' + error.message, 'error');
            }
        }
        
        async function normalizeSelectedFiles() {
            if (selectedFiles.size === 0) {
                showMessage('No files selected', 'error');
                return;
            }
            
            if (!confirm(`This will normalize metadata for ${selectedFiles.size} selected file${selectedFiles.size > 1 ? 's' : ''}. Continue?`)) {
                return;
            }
            
            showMessage('Normalizing metadata for selected files... This may take a while.', 'info');
            
            try {
                const response = await fetch('/api/normalize-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: Array.from(selectedFiles)
                    })
                });
                
                const result = await response.json();
                
                const successCount = result.results.filter(r => r.success).length;
                showMessage(`Normalized metadata for ${successCount} of ${result.results.length} files successfully!`, 'success');
                
                // Refresh file list (force refresh to clear cache)
                await loadFiles(1, true);
            } catch (error) {
                showMessage('Failed to normalize metadata: ' + error.message, 'error');
            }
        }
        
        async function processSingleFile(filepath) {
            if (!confirm(`Process ${filepath}?`)) {
                return;
            }
            
            showMessage('Processing file...', 'info');
            
            try {
                const response = await fetch(`/api/process-file/${encodeURIComponent(filepath)}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('File processed successfully!', 'success');
                    await loadFiles(currentPage, true);
                } else {
                    showMessage(result.error || 'Failed to process file', 'error');
                }
            } catch (error) {
                showMessage('Failed to process file: ' + error.message, 'error');
            }
        }
        
        async function renameSingleFile(filepath) {
            if (!confirm(`Rename ${filepath} based on metadata?`)) {
                return;
            }
            
            showMessage('Renaming file...', 'info');
            
            try {
                const response = await fetch(`/api/rename-file/${encodeURIComponent(filepath)}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('File renamed successfully!', 'success');
                    await loadFiles(currentPage, true);
                } else {
                    showMessage(result.error || 'Failed to rename file', 'error');
                }
            } catch (error) {
                showMessage('Failed to rename file: ' + error.message, 'error');
            }
        }
        
        async function normalizeSingleFile(filepath) {
            if (!confirm(`Normalize metadata for ${filepath}?`)) {
                return;
            }
            
            showMessage('Normalizing metadata...', 'info');
            
            try {
                const response = await fetch(`/api/normalize-file/${encodeURIComponent(filepath)}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Metadata normalized successfully!', 'success');
                    await loadFiles(currentPage, true);
                } else {
                    showMessage(result.error || 'Failed to normalize metadata', 'error');
                }
            } catch (error) {
                showMessage('Failed to normalize metadata: ' + error.message, 'error');
            }
        }
        
        async function deleteSingleFile(filepath) {
            if (!confirm(`Are you sure you want to delete ${filepath}?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            showMessage('Deleting file...', 'info');
            
            try {
                const response = await fetch(`/api/delete-file/${encodeURIComponent(filepath)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('File deleted successfully!', 'success');
                    await loadFiles(currentPage, true);
                } else {
                    showMessage(result.error || 'Failed to delete file', 'error');
                }
            } catch (error) {
                showMessage('Failed to delete file: ' + error.message, 'error');
            }
        }
        
        function refreshFiles() {
            showMessage('Refreshing file list...', 'info');
            loadFiles(currentPage, true);
        }
        
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            
            container.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }
        
        async function openSettings() {
            try {
                const response = await fetch('/api/settings/filename-format');
                const data = await response.json();
                
                document.getElementById('filenameFormat').value = data.format || '';
                document.getElementById('currentFormat').textContent = data.format || data.default;
                document.getElementById('settingsModal').classList.add('active');
            } catch (error) {
                showMessage('Failed to load settings: ' + error.message, 'error');
            }
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        async function saveFilenameFormat() {
            const format = document.getElementById('filenameFormat').value.trim();
            
            if (!format) {
                showMessage('Filename format cannot be empty', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/settings/filename-format', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ format: format })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Filename format saved successfully!', 'success');
                    closeSettings();
                } else {
                    showMessage(result.error || 'Failed to save filename format', 'error');
                }
            } catch (error) {
                showMessage('Failed to save filename format: ' + error.message, 'error');
            }
        }
        
        async function resetFilenameFormat() {
            try {
                const response = await fetch('/api/settings/filename-format');
                const data = await response.json();
                
                document.getElementById('filenameFormat').value = data.default;
                showMessage('Reset to default format', 'info');
            } catch (error) {
                showMessage('Failed to reset format: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
